@model Playground.Mvc.Controllers.CompellingExample1Model
@using Newtonsoft.Json


@{
    ViewBag.Title = "CompellingExample1";
}

<link href="@Url.Content("~/Content/toastr.min.css")" rel="stylesheet" type="text/css" />

<h2>CompellingExample1</h2>

<br />


<div class="row">
    <div class="col-md-4">
        <fieldset>
            <legend>Select Source / Target Id</legend>
            <div class="row">
                <div class="col-md-2 text-right">
                    Source:
                </div>
                <div class="col-sm-10">
                    <select data-bind="options: sourceIds, value: selectedSourceId, optionsCaption: 'Choose...'" style="width:200px;"></select>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-2 text-right">
                    Target:
                </div>
                <div class="col-sm-10">
                    <select multiple data-bind="options: targetIds, selectedOptions: selectedTargetIds, optionsCaption: 'Choose...'" style="width:200px; height:150px;"></select>
                </div>
            </div>
            <br />
            <div class="row">
                <div class="col-md-2 text-right"></div>
                <div class="col-sm-10">
                    <button type="button" class="btn btn-primary" data-bind="click: GetRouteOperToCopy">Get Route/Oper to Copy</button>
                </div>
            </div>
        </fieldset>
    </div>

    <div class="col-md-8" data-bind="visible: displaySelectOperDiv()">
        <fieldset>
            <legend>Select Operations to copy</legend>
            <div class="row">
                <div class="col-md-2">
                </div>
                <div data-bind="foreach: commonRouteOpers ">
                    <ul data-bind="foreach: TargetRouteOper">
                        <li data-bind="text: RouteAndTargetId"></li>
                        <ul data-bind="foreach: Operations">
                            <li>
                                <input type="checkbox" name="level-2"
                                       data-bind="checked: IsSelected">
                                <span data-bind="text: Operation"></span>
                            </li>
                        </ul>
                    </ul>
                </div>
            </div>

            <br />

            <div class="row">
                <div class="col-md-2 text-right"></div>
                <div class="col-sm-10">
                    <button type="button" class="btn btn-primary" data-bind="click: CopySelectedOpers">Copy Selected Oper(s)</button>
                </div>
            </div>
        </fieldset>
    </div>
</div>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryui")
    @Scripts.Render("~/bundles/knockout/js")
    <script src="@Url.Content("~/Scripts/knockout.mapping-latest.js")" type="text/javascript"></script>

    <script src="@Url.Content("~/Scripts/toastr.min.js")" type="text/javascript"></script>

    <script type="text/javascript">
            @{
        var json = JsonConvert.SerializeObject(Model);
    }

    @Html.Raw("var model = " + json)

        var viewModel = new CompellingExampleViewModel({
            ids: model.Ids
    });

    $(document).ready(function () {
        viewModel.initialize();
    });

    function CompellingExampleViewModel(args) {

        var self = this;

        // properties
        self.sourceIds = ko.observableArray(args.ids);
        self.selectedSourceId = ko.observable();
        self.targetIds = ko.observableArray([]);
        self.selectedTargetIds = ko.observableArray([]);
        self.isInitialized = ko.observable(false);
        self.displaySelectOperDiv = ko.observable(false);
        self.commonRouteOpers = ko.observableArray([]);

        self.selectedSourceId.subscribe(function (newValue) {
            if (newValue) {
                self.targetIds([]); //reset target
                self.selectedTargetIds([]); //Reset selections as well

                $.ajax({
                    url: '@Url.Action("GetTargetIds", "KnockoutStuff")',
                    cache: false,
                    dataType: "json",
                    type: "POST",
                    traditional: true,
                    contentType: 'application/json',
                    data: JSON.stringify({ sourceId: newValue }),
                    success: function (data) {
                        if (data.success) {
                            self.targetIds(ko.mapping.fromJS(data.targetIds.Ids)());
                        } else {
                            toastr["error"](data.message, 'Error');
                        }
                    },
                    error: function (response) {
                        toastr["error"](response, 'Error');
                    }
                });

            }
        });

        self.GetRouteOperToCopy = function () {

            if (self.selectedSourceId() === undefined || self.selectedSourceId().length === 0) {
                toastr["error"]("You must select Source Id", 'Error');
                return false;
            }

            if (self.selectedTargetIds() === undefined || self.selectedTargetIds().length === 0) {
                toastr["error"]("You must select at least one Target Id", 'Error');
                return false;
            }

            var targetIds = self.selectedTargetIds();

            $.ajax({
                url: '@Url.Action("GetRouteOpersToCopy", "KnockoutStuff")',
                cache: false,
                dataType: "json",
                type: "POST",
                traditional: true,
                contentType: 'application/json',
                data: JSON.stringify({ sourceId: self.selectedSourceId(), targetIds: targetIds}),
                success: function (data) {
                    if (data.success) {
                        if (data.commonRouteOpers.FoundCommonOperations) {
                            var x = ko.mapping.fromJS(data.commonRouteOpers);
                            self.commonRouteOpers(ko.mapping.fromJS(data.commonRouteOpers));
                            if (self.commonRouteOpers().TargetRouteOper().length > 0) {
                                self.displaySelectOperDiv(true);
                            }
                        } else {
                            toastr["error"]("No common Route/Oper found for the selected target Ids.", 'Error');
                        }
                    } else {
                        toastr["error"](data.message, 'Error');
                    }
                },
                error: function (response) {
                    toastr["error"](response, 'Error');
                }
            });
        }

        self.CopySelectedOpers = function () {
            //validate
            var selectedOpers = [];
            for (var i = 0; i < self.commonRouteOpers().TargetRouteOper().length; i++) {
                var oper = self.commonRouteOpers().TargetRouteOper()[i];
                for (var j = 0; j < oper.Operations().length; j++) {
                    var item = oper.Operations()[j];
                    if (item.IsSelected()) {
                        selectedOpers.push(item.Operation());
                    }
                }
            }

            if (selectedOpers.length === 0) {
                toastr["error"]("Please select at least one Operation and try again!", 'Error');
                return false;
            }

            var result = ko.mapping.toJS(self.commonRouteOpers());

            $.ajax({
                url: '@Url.Action("CopySelectedOperations", "KnockoutStuff")',
                cache: false,
                dataType: "json",
                type: "POST",
                traditional: true,
                contentType: 'application/json',
                data: JSON.stringify(result),
                success: function (data) {
                    if (data.success) {
                        self.commonRouteOpers(undefined);
                        self.selectedTargetIds([]);
                        self.selectedSourceId(undefined);

                        toastr["info"]("Route copied successfully.", 'Info');

                        self.displaySelectOperDiv(false);

                    } else {
                        toastr["error"](data.message, 'Error');
                    }
                },
                error: function (response) {
                    toastr["error"](response, 'Error');
                }
            });
        }

        self.initialize = function () {

            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-top-center",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };

            ko.applyBindings(self);

            self.isInitialized(true);
        }
    }
    </script>
}